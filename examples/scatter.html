<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="../dist/bundle.js"></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <main>
      <h1>Scatter</h1>
      <svg class="chart" width="500" height="500">
      </svg>
      <p>This examples illustrates how <a href="https://github.com/signal-noise/index-core/">indexCore</a> can be used to show data accross diferent entities</p>
      <p>Data from the <a href="https://github.com/signal-noise/dupont_wateroptimisation_7754">water optimisation index</a></p>
      <footer><a href="index.html">Examples index</a></footer>
    </main>
    <div class="tooltip"></div>
  </body>
  <script>

  function drawScatter(core, xIndicator, yIndicator){
    let width = 500;
    let height =Â 500;
    let margin = { top:50, left:50, bottom:50, right:50 };
    let plotWidth = width-(margin.left + margin.right);
    let plotHeight = height-(margin.top + margin.bottom);
    const chartData = Object.entries(core.indexedData)
      .map(([entity, scores])=>({
        xValue:Number(scores[xIndicator]),
        yValue:Number(scores[yIndicator]),
        entity
      }));

    let scaleX = d3.scaleLinear()
      .domain([0, d3.max(chartData, d=>d.xValue)])
      .range([0, plotWidth]);

    let scaleY = d3.scaleLinear()
      .domain([0,d3.max(chartData, d=>d.yValue)])
      .range([plotHeight, 0]);

    d3.select('.chart')
      .attr("viewBox", [0, 0, width, height])
      .attr('width', width)
      .attr('height', height)
      .append('g')
        .attr('class', 'plot')
        .attr('transform', `translate(${margin.left}, ${margin.top})`)
      .selectAll('g.point')
        .data(chartData, d=>d.entity)
        .join('g')
          .attr('class','point')
        .append('circle')
          .attr('cx', d => scaleX(d.xValue))
          .attr('cy', d => scaleY(d.yValue))
          .attr('r', 5)
        .on('mouseover',(ev, d)=>{
            d3.select('.tooltip')
            .html(`${d.entity}: <br>
            ${d.xValue.toFixed(2)}, ${d.yValue.toFixed(2)}`)
            .style('opacity', 1)
            .style('top', ev.pageY)
            .style('left', ev.pageX)
        })
        .on('mousemove',ev=>{
          d3.select('.tooltip')
            .style('top', ev.pageY)
            .style('left', ev.pageX)
        })
        .on('mouseout',ev=>{
          d3.select('.tooltip')
            .style('opacity',0)
            .style('top', ev.pageY)
            .style('left', ev.pageX)
        });;
// Axes and labeling...
    d3.select('.chart')
      .append('g')
        .attr('transform',`translate(${margin.left},${margin.top})`)
        .attr('class','yaxis')
      .call(d3.axisLeft(scaleY))

    d3.select('.chart')
      .append('g')
        .attr('transform',`translate(${margin.left},${margin.top+plotHeight})`)
        .attr('class','xaxis')
      .call(d3.axisBottom(scaleX));

    d3.select('.chart')
      .append('text')
      .attr('text-anchor','middle')
      .attr('transform',`translate(${margin.left},${margin.top + plotHeight/2}) rotate(-90)`)
      .attr('dy',-38)
      .text(`${core.getIndicator(yIndicator).description} (${yIndicator})`)

    d3.select('.chart')
      .append('text')
      .attr('text-anchor','middle')
      .attr('transform',`translate(${margin.left+plotWidth/2},${height})`)
      .attr('dy', -3)
      .text(`${core.getIndicator(xIndicator).description} (${xIndicator})`)
  }
    

  Promise
    .all([
      d3.csv('../data/wateroptimisation/entities.csv'),
      d3.csv('../data/wateroptimisation/indicators.csv'),
    ])
    .then(([entities, indicators])=>{
      const waterOptimisationIndex = indexCore(indicators, entities);
      drawScatter(waterOptimisationIndex, '1.1','1.3')
    });
    
  </script>
</html>